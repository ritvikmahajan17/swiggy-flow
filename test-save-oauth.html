<!DOCTYPE html>
<html>
<head>
    <title>Test Save OAuth Tokens</title>
</head>
<body>
    <h1>Test Save OAuth Tokens Function</h1>
    <button onclick="testGoogleSave()">Test Google Token Save</button>
    <button onclick="testSlackSave()">Test Slack Token Save</button>
    <button onclick="testDiscordSave()">Test Discord Save</button>
    <pre id="output"></pre>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        const supabaseUrl = "https://ddmytypyxaumamqrofgz.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbXl0eXB5eGF1bWFtcXJvZmd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjA0MTAsImV4cCI6MjA3NjAzNjQxMH0.xhZ7WKrxorgcC0lU25_L9_RqwpGKLY-XNLuyF3Y5ICk";
        const supabase = createClient(supabaseUrl, supabaseKey);

        const output = document.getElementById('output');

        function log(message) {
            output.textContent += message + '\n';
            console.log(message);
        }

        async function testAPI(provider, payload) {
            try {
                log(`\n=== Testing ${provider} ===`);

                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    log('ERROR: No session found. Please login with Google first at /public/swiggy_auth_login.html');
                    return;
                }

                log(`User ID: ${session.user.id}`);
                log(`Request payload: ${JSON.stringify(payload, null, 2)}`);

                const response = await fetch(
                    `${supabaseUrl}/functions/v1/save-oauth-tokens`,
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${session.access_token}`,
                        },
                        body: JSON.stringify(payload),
                    }
                );

                log(`Response status: ${response.status} ${response.statusText}`);

                const responseData = await response.json();
                log(`Response data: ${JSON.stringify(responseData, null, 2)}`);

                if (response.ok) {
                    log(`✓ SUCCESS: ${provider} tokens saved`);
                } else {
                    log(`✗ FAILED: ${responseData.error || 'Unknown error'}`);
                }
            } catch (error) {
                log(`✗ ERROR: ${error.message}`);
                console.error(error);
            }
        }

        window.testGoogleSave = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                log('Please login first');
                return;
            }

            await testAPI('Google', {
                userId: session.user.id,
                provider: "google",
                accessToken: "test_google_token_" + Date.now(),
                refreshToken: "test_google_refresh_" + Date.now(),
            });
        };

        window.testSlackSave = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                log('Please login first');
                return;
            }

            await testAPI('Slack', {
                userId: session.user.id,
                provider: "slack_oidc",
                slack_token: "test_slack_token_" + Date.now(),
                slack_user_id: "U12345678",
            });
        };

        window.testDiscordSave = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                log('Please login first');
                return;
            }

            await testAPI('Discord', {
                userId: session.user.id,
                provider: "discord",
                discord_token: "test_discord_token_" + Date.now(),
                discord_user_id: "123456789012345678",
                discord_connected: true,
            });
        };

        // Check session on load
        (async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                log(`Logged in as: ${session.user.email || session.user.id}`);
            } else {
                log('Not logged in. Please login at /public/swiggy_auth_login.html first');
            }
        })();
    </script>
</body>
</html>
